<view class="page-container">
  <view class="calendar-section">
    <view class="calendar-header">
      <view class="text-btn text-btn-danger" bindtap="onClearAll">清除</view>
      <view style="display: flex; align-items: center;">
        <view class="month-nav-btn" bindtap="onPrevMonth">
          <text class="nav-arrow">‹</text>
        </view>
        <view class="current-month">{{currentYear}}年{{currentMonth}}月</view>
        <view class="month-nav-btn" bindtap="onNextMonth">
          <text class="nav-arrow">›</text>
        </view>
      </view>
      <view class="add-btn-text" bindtap="onShowAddDialog">新增</view>
    </view>

    <view class="weekdays-row">
      <view class="weekday {{index === 0 || index === 6 ? 'weekday-weekend' : ''}}" wx:for="{{['日','一','二','三','四','五','六']}}" wx:key="*this">{{item}}</view>
    </view>

    <view class="days-container">
      <view class="week-row" wx:for="{{calendarWeeks}}" wx:for-item="week" wx:key="index">
        <view class="day-cell {{item.empty ? 'day-cell-empty' : ''}} {{item.isToday ? 'day-cell-today' : ''}} {{item.isPast ? 'day-cell-past' : ''}} {{item.isFuture ? 'day-cell-future' : ''}} {{item.dateKey === selectedDate ? 'day-cell-selected' : ''}} {{item.hasIncomplete ? 'day-cell-has-todo-incomplete' : ''}}"
          wx:for="{{week.days}}"
          wx:for-item="item"
          wx:key="dateKey"
          bindtap="onSelectDate"
          data-datekey="{{item.dateKey}}">
          <view class="day-text {{item.hasIncomplete ? 'day-text-has-incomplete' : ''}} {{item.hasCompleted && !item.hasIncomplete ? 'day-text-has-completed' : ''}}" wx:if="{{!item.empty}}">{{item.day}}</view>
        </view>
      </view>
    </view>
  </view>

  <view class="selected-date-section">
    <view class="selected-todos">
      <block wx:if="{{selectedDateTodos.length > 0}}">
        <view class="todo-collapse-list">
          <block wx:for="{{selectedDateTodos}}" wx:for-index="index" wx:key="_id">
            <view class="todo-wrapper {{index !== selectedDateTodos.length - 1 ? 'todo-wrapper-has-border' : ''}}">
              <van-swipe-cell right-width="120" disabled="{{item.completed || item.abandoned}}">
                <view class="todo-item-base" bindtap="onToggleExpand" data-id="{{item._id}}">
                  <view class="importance-bar importance-bar-{{item.importance === 1 ? 'low' : item.importance === 3 ? 'high' : 'medium'}}"></view>
                  <view class="todo-header">
                    <view class="todo-title-row">
                      <text class="todo-title {{item.completed ? 'todo-title-completed' : ''}} {{item.abandoned ? 'todo-title-abandoned' : ''}}">{{item.title}}</text>
                      <view class="expand-arrow {{expandedTodoId === item._id ? 'expand-arrow-expanded' : ''}}">▼</view>
                    </view>
                  </view>
                </view>
                <view slot="right" class="swipe-right-actions" data-id="{{item._id}}">
                  <view class="action-btn action-btn-edit" bindtap="onEditTodo" data-id="{{item._id}}">编辑</view>
                  <view class="action-btn action-btn-delete" bindtap="onDeleteTodo" data-id="{{item._id}}">删除</view>
                </view>
              </van-swipe-cell>
              <view class="collapse-content {{expandedTodoId === item._id ? 'collapse-content-expanded' : ''}}">
                <view class="detail-text" wx:if="{{item.content}}">
                  <text>{{item.content}}</text>
                </view>
                <view class="detail-text detail-text-empty" wx:else>
                  <text>暂无详细内容</text>
                </view>
              </view>
            </view>
          </block>
        </view>
      </block>
      <view class="empty-tip" wx:else>
        <text>暂无待办事项</text>
      </view>
    </view>
  </view>

  <!-- 编辑/新增对话框 -->
  <van-dialog
    use-slot
    title="{{showAddDialog ? '新增待办' : '编辑待办'}}"
    show="{{showEditDialog || showAddDialog}}"
    show-cancel-button
    bind:confirm="onSaveEdit"
    bind:cancel="onCancelEdit"
    confirm-button-text="保存"
    cancel-button-text="取消"
    confirm-button-color="#1989fa">
    <view class="edit-dialog" catchtouchmove="onStopPropagation">
      <view class="dialog-field">
        <view class="dialog-field-row">
          <text class="dialog-label">标题<text class="required-star">*</text></text>
          <input class="dialog-input" value="{{editTitle}}" bindinput="onEditTitleChange" placeholder="请输入标题" />
        </view>
      </view>
      <view class="dialog-field">
        <text class="dialog-label">内容</text>
        <textarea class="dialog-textarea" value="{{editContent}}" bindinput="onEditContentChange" placeholder="请输入内容" />
      </view>
      <view class="dialog-field">
        <view class="importance-options">
          <view class="importance-option {{editImportance === 1 ? 'active importance-low' : ''}}" bindtap="onImportanceChange" data-value="1">低</view>
          <view class="importance-option {{editImportance === 2 ? 'active importance-mid' : ''}}" bindtap="onImportanceChange" data-value="2">中</view>
          <view class="importance-option {{editImportance === 3 ? 'active importance-high' : ''}}" bindtap="onImportanceChange" data-value="3">高</view>
        </view>
      </view>
      <!-- 编辑和新增都只显示截至和不限 -->
      <view class="dialog-field">
        <view class="dialog-field-row">
          <text class="dialog-label">截至</text>
          <picker mode="date" value="{{editDate || selectedDate}}" bindchange="onDateChange">
            <view class="dialog-picker">{{editDate || selectedDate}}</view>
          </picker>
          <text class="dialog-label">不限</text>
          <switch checked="{{editPermanent}}" bindchange="onPermanentChange" />
        </view>
      </view>
    </view>
  </van-dialog>

  <!-- 删除确认对话框 -->
  <van-dialog
    title="确认删除"
    message="确定要删除这条待办吗？"
    show="{{showDeleteDialog}}"
    show-cancel-button
    bind:confirm="onConfirmDelete"
    bind:cancel="onCancelDelete"
    confirm-button-text="确定"
    cancel-button-text="取消"
    confirm-button-color="#1989fa" />
</view>
