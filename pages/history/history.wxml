<view class="page-container">
  <view class="calendar-section">
    <view class="calendar-header">
      <view class="month-nav-btn" bindtap="onPrevMonth">
        <text class="nav-arrow">‹</text>
      </view>
      <view class="current-month">{{currentYear}}年{{currentMonth}}月</view>
      <view class="month-nav-btn" bindtap="onNextMonth">
        <text class="nav-arrow">›</text>
      </view>
    </view>

    <view class="weekdays-row">
      <view class="weekday" wx:for="{{['日','一','二','三','四','五','六']}}" wx:key="*this">{{item}}</view>
    </view>

    <view class="days-container">
      <block wx:for="{{calendarWeeks}}" wx:key="index">
        <view class="week-row">
          <view 
            class="day-cell {{day.empty ? 'day-cell-empty' : ''}} {{day.isToday ? 'day-cell-today' : ''}} {{day.dateKey === selectedDate ? 'day-cell-selected' : ''}} {{day.hasIncomplete ? 'day-cell-has-todo-incomplete' : ''}}"
            wx:for="{{item.days}}"
            wx:for-item="day"
            wx:key="dateKey"
            bindtap="onSelectDate"
            data-datekey="{{day.dateKey}}">
            <text class="day-text {{day.hasIncomplete ? 'day-text-has-incomplete' : ''}} {{day.hasCompleted && !day.hasIncomplete ? 'day-text-has-completed' : ''}}" wx:if="{{!day.empty}}">{{day.day}}</text>
          </view>
        </view>
      </block>
    </view>
  </view>

  <!-- 当前日期标题 -->
  <view class="date-header">
    <view class="date-left">
      <view class="date-dot"></view>
      <text class="date-title">{{currentMonth}}月{{selectedDateDay}}日 任务</text>
    </view>
    <view class="add-btn-small" bindtap="onShowAddDialog">+ 新增</view>
  </view>

  <view class="selected-date-section">
    <view class="selected-todos">
      <block wx:if="{{selectedDateTodos.length > 0}}">
        <view class="todo-list">
          <van-swipe-cell right-width="{{item.completed ? 0 : 60}}" disabled="{{item.completed}}" wx:for="{{selectedDateTodos}}" wx:key="_id" data-id="{{item._id}}">
            <view class="todo-card {{item.completed ? 'todo-card-completed' : ''}}">
              <view class="todo-card-left-bar"></view>
              <view class="todo-card-content">
                <view class="todo-info" bindtap="onEditTodo" data-id="{{item._id}}">
                  <text class="todo-title {{item.completed ? 'todo-title-completed' : ''}}">{{item.title}}</text>
                  <text class="todo-desc" wx:if="{{item.content}}">{{item.content}}</text>
                </view>
              </view>
            </view>
            <view slot="right" class="swipe-right-actions">
              <view class="action-btn action-btn-delete" catchtap="onDeleteTodo" data-id="{{item._id}}">删除</view>
            </view>
          </van-swipe-cell>
        </view>
      </block>
      <view class="empty-tip" wx:else>
        <text>暂无待办事项</text>
      </view>
    </view>
  </view>

  <!-- 编辑/新增对话框 -->
  <van-dialog
    use-slot
    title="{{showAddDialog ? '新增待办' : '编辑待办'}}"
    show="{{showEditDialog || showAddDialog}}"
    show-cancel-button
    bind:confirm="onSaveEdit"
    bind:cancel="onCancelEdit"
    confirm-button-text="保存"
    cancel-button-text="取消"
    confirm-button-color="#1989fa">
    <view class="edit-dialog" catchtouchmove="onStopPropagation">
      <view class="dialog-field">
        <view class="dialog-field-row">
          <text class="dialog-label">标题<text class="required-star">*</text></text>
          <input class="dialog-input" value="{{editTitle}}" bindinput="onEditTitleChange" placeholder="请输入标题" />
        </view>
      </view>
      <view class="dialog-field">
        <text class="dialog-label">内容</text>
        <textarea class="dialog-textarea" value="{{editContent}}" bindinput="onEditContentChange" placeholder="请输入内容" />
      </view>
      <view class="dialog-field">
        <view class="dialog-field-row">
          <text class="dialog-label">截至</text>
          <picker mode="date" value="{{editDate || selectedDate}}" bindchange="onDateChange">
            <view class="dialog-picker">{{editDate || selectedDate}}</view>
          </picker>
          <text class="dialog-label">不限</text>
          <switch checked="{{editPermanent}}" bindchange="onPermanentChange" />
        </view>
      </view>
    </view>
  </van-dialog>

  <!-- 删除确认对话框 -->
  <van-dialog
    title="确认删除"
    message="确定要删除这条待办吗？"
    show="{{showDeleteDialog}}"
    show-cancel-button
    bind:confirm="onConfirmDelete"
    bind:cancel="onCancelDelete"
    confirm-button-text="确定"
    cancel-button-text="取消"
    confirm-button-color="#1989fa" />
</view>
