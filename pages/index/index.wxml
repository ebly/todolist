<view class="page-container">
  <scroll-view class="list-container" scroll-y enable-flex>
    <!-- 空状态 -->
    <view class="empty-tip" wx:if="{{!todos || todos.length === 0}}">暂无待办事项</view>

    <view class="todo-collapse-list" wx:if="{{todos && todos.length > 0}}">
      <view class="todo-wrapper {{idx !== todos.length - 1 ? 'todo-wrapper-has-border' : ''}}" wx:for="{{todos}}" wx:for-index="idx" wx:key="_id">
        <van-swipe-cell right-width="{{item.completed || item.abandoned ? 0 : 120}}" disabled="{{item.completed || item.abandoned}}" data-id="{{item._id}}">
          <view class="todo-item-base" bindtap="onToggleExpand" data-id="{{item._id}}">
            <view class="importance-bar importance-bar-{{item.importance === 1 ? 'low' : item.importance === 3 ? 'high' : 'medium'}}"></view>
            <view class="todo-content">
              <view class="todo-bg-progress" wx:if="{{!item.completed && !item.abandoned}}">
                <view class="todo-bg-progress-fill importance-{{item.importance === 1 ? 'low' : item.importance === 3 ? 'high' : 'medium'}}" style="width: {{item.progressPercent}}%;"></view>
              </view>
              <view class="todo-header-center">
                <text class="todo-title {{item.completed ? 'todo-title-completed' : ''}} {{item.abandoned ? 'todo-title-abandoned' : ''}}">{{item.title}}</text>
                <view class="todo-right-section">
                  <text class="days-badge {{item.daysLeft <= 1 ? 'urgent' : item.daysLeft <= 3 ? 'warning' : ''}}" wx:if="{{!item.completed && !item.abandoned}}">{{item.daysLeftText}}</text>
                  <text class="days-badge completed" wx:if="{{item.completed}}">已完成</text>
                  <text class="days-badge abandoned" wx:if="{{item.abandoned}}">已放弃</text>
                  <view class="expand-arrow {{expandedTodoId === item._id ? 'expand-arrow-expanded' : ''}}">▼</view>
                </view>
              </view>
            </view>
          </view>
          <view slot="right" class="swipe-right-actions" data-id="{{item._id}}">
            <view class="action-btn action-btn-edit" catchtap="onToggleTodo" data-id="{{item._id}}">完成</view>
            <view class="action-btn action-btn-delete" catchtap="onAbandonTodo" data-id="{{item._id}}">放弃</view>
          </view>
        </van-swipe-cell>
        <view class="collapse-content {{expandedTodoId === item._id ? 'collapse-content-expanded' : ''}}">
          <view class="detail-text" wx:if="{{item.content}}">
            <text>{{item.content}}</text>
          </view>
          <view class="detail-text detail-text-empty" wx:else>
            <text>暂无详细内容</text>
          </view>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- 放弃确认对话框 -->
  <van-dialog
    title="确认放弃"
    message="确定要放弃这条待办吗？"
    show="{{showAbandonDialog}}"
    show-cancel-button
    bind:confirm="onConfirmAbandon"
    bind:cancel="onCancelAbandon"
    confirm-button-text="确定"
    cancel-button-text="取消"
    confirm-button-color="#ff4d4f" />

  <!-- 编辑对话框 -->
  <van-dialog
    use-slot
    title="编辑待办"
    show="{{showEditDialog}}"
    show-cancel-button
    bind:confirm="onSaveEdit"
    bind:cancel="onCancelEdit"
    confirm-button-text="保存"
    cancel-button-text="取消"
    confirm-button-color="#1989fa">
    <view class="edit-dialog">
      <view class="dialog-field">
        <text class="dialog-label">待办标题</text>
        <input class="dialog-input" value="{{editTitle}}" bindinput="onEditTitleInput" placeholder="请输入待办标题"/>
      </view>
      <view class="dialog-field">
        <text class="dialog-label">详细内容</text>
        <textarea class="dialog-textarea" value="{{editContent}}" bindinput="onEditContentInput" placeholder="请输入详细内容（可选）"/>
      </view>
      <view class="dialog-field">
        <text class="dialog-label">重要程度</text>
        <view class="importance-selector">
          <view class="importance-option {{editImportance === 1 ? 'selected' : ''}}" bindtap="onSelectImportance" data-value="1">低</view>
          <view class="importance-option {{editImportance === 2 ? 'selected' : ''}}" bindtap="onSelectImportance" data-value="2">中</view>
          <view class="importance-option {{editImportance === 3 ? 'selected' : ''}}" bindtap="onSelectImportance" data-value="3">高</view>
        </view>
      </view>
    </view>
  </van-dialog>
</view>
